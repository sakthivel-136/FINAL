# -*- coding: utf-8 -*-
"""mic_chat

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19Ei3nfgH_cdVVbbmd-_EQurgt7s4rvQs
"""

# mic_chat.py: Streamlit Voice-Enabled KCET ChatBot

import streamlit as st
import pandas as pd
import os
import pickle
import speech_recognition as sr
import pyttsx3
import tempfile
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity

# Constants
VECTOR_FILE = "vectorized.pkl"
CSV_FILE = "kcet.csv"
THRESHOLD = 0.8

# Text-to-speech engine
engine = pyttsx3.init()
def speak(text):
    engine.say(text)
    engine.runAndWait()

# Load or vectorize CSV data
def load_or_vectorize():
    if os.path.exists(VECTOR_FILE):
        with open(VECTOR_FILE, "rb") as f:
            vectorizer, vectors, df = pickle.load(f)
    else:
        df = pd.read_csv(CSV_FILE)
        df['Question'] = df['Question'].str.strip().str.lower()
        vectorizer = TfidfVectorizer()
        vectors = vectorizer.fit_transform(df['Question'])
        with open(VECTOR_FILE, "wb") as f:
            pickle.dump((vectorizer, vectors, df), f)
    return vectorizer, vectors, df

vectorizer, vectors, df = load_or_vectorize()

# Recognize speech input
def recognize_speech():
    recognizer = sr.Recognizer()
    with sr.Microphone() as source:
        st.info("ğŸ™ï¸ Listening... Speak now.")
        audio = recognizer.listen(source, timeout=5, phrase_time_limit=8)
    try:
        query = recognizer.recognize_google(audio)
        return query.lower()
    except sr.UnknownValueError:
        return ""
    except sr.RequestError:
        return ""

# Setup Streamlit UI
st.set_page_config(page_title="KCET Voice ChatBot", layout="centered")
st.title("ğŸ“ KCET Voice Assistant")

if st.button("ğŸ¤ Record & Ask"):
    query = recognize_speech()
    if query:
        st.markdown(f"**ğŸ‘¤ You said:** {query}")
        query_vector = vectorizer.transform([query])
        similarity = cosine_similarity(query_vector, vectors)
        max_sim = similarity.max()
        max_index = similarity.argmax()

        if max_sim >= THRESHOLD:
            answer = df.iloc[max_index]['Answer']
        else:
            answer = "âŒ Sorry, I couldn't understand that. Please rephrase."

        st.markdown(f"**ğŸ¤– Bot:** {answer}")
        speak(answer)
    else:
        st.warning("â— Could not capture any clear speech. Please try again.")
